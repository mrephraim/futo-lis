<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head th:insert="fragments :: head(title = 'ADD PATIENT - EMR - FUTO HIS')"></head>
<body>

<div class="container mt-5">
    <div class="mb-5" th:insert="fragments :: headerOne(title='NEW PATIENT - FUTO EMR')"></div>
    <div class="d-flex justify-content-start mt-3 mb-3">
        <a href="/emr/dashboard/" class="btn btn-secondary me-3">Go Back</a>
    </div>
    <form id="addPatientForm">
        <div th:if="${errors}">
            <ul>
                <li class="text-danger" th:each="error : ${errors}" th:text="${error}"></li>
            </ul>
        </div>

        <div class="table-responsive">
            <table class="table table-bordered table-striped">
                <tbody>
                <tr>
                    <th>Reg No</th>
                    <td><input type="text" pattern="\d{11}" class="form-control" name="regNo" placeholder="Student Reg No" required></td>
                </tr>
                <tr>
                    <th>First Name</th>
                    <td><input type="text" class="form-control" name="firstName" placeholder="First Name" required></td>
                </tr>
                <tr>
                    <th>Surname</th>
                    <td><input type="text" class="form-control" name="surName" placeholder="Surname" required></td>
                </tr>
                <tr>
                    <th>Middle Name</th>
                    <td><input type="text" class="form-control" name="middleName" placeholder="Middle Name (optional)"></td>
                </tr>
                <tr>
                    <th>School</th>
                    <td>
                        <select class="form-control" id="schools" name="schools" onchange="populateDepartments(this.value)" required>
                            <option value="">--Select School--</option>
                            <option value="SAAT">School of Agriculture And Agricultural Technology (SAAT)</option>
                            <option value="SBMS">School of Basic Medical Science (SBMS)</option>
                            <option value="SOBS">School of Biological Science (SOBS)</option>
                            <option value="SEET">School of Engineering and Engineering Technology (SEET)</option>
                            <option value="SESET">School of Electrical Systems and Engineering Technology (SESET)</option>
                            <option value="SOES">School of Environmental Science (SOES)</option>
                            <option value="SOHT">School of Health Technology (SOHT)</option>
                            <option value="SICT">School of Information and Communication Technology (SICT)</option>
                            <option value="SLIT">School of Logistics and Innovation Technology (SLIT)</option>
                            <option value="SOPS">School of Physical Science (SOPS)</option>
                            <option value="SPGS">School of Postgraduate Studies (SPGS)</option>
                        </select>
                    </td>
                </tr>
                <tr>
                    <th>Department</th>
                    <td>
                        <select class="form-control" id="departments" name="departments">
                            <option value="">--Select Department--</option>
                            <!-- Department options will be populated here based on the selected school -->
                        </select>
                    </td>
                </tr>
                <tr>
                    <th>Phone Number</th>
                    <td><input type="tel" class="form-control" name="phoneNo" placeholder="Phone Number" required></td>
                </tr>
                <tr>
                    <th>Email</th>
                    <td><input type="email" class="form-control" name="email" placeholder="Email Address" required></td>
                </tr>
                <tr>
                    <th>Date of Birth</th>
                    <td>
                        <div class="d-flex flex-wrap">
                            <select class="form-control me-2" name="dob_day" required style="max-width: 80px;">
                                <option value="">Day</option>
                                <!-- Generate day options from 1 to 31 -->
                                <script>
                                    for (let day = 1; day <= 31; day++) {
                                        document.write(`<option value="${day}">${day}</option>`);
                                    }
                                </script>
                            </select>

                            <select class="form-control me-2" name="dob_month" required style="max-width: 120px;">
                                <option value="">Month</option>
                                <option value="1">January</option>
                                <option value="2">February</option>
                                <option value="3">March</option>
                                <option value="4">April</option>
                                <option value="5">May</option>
                                <option value="6">June</option>
                                <option value="7">July</option>
                                <option value="8">August</option>
                                <option value="9">September</option>
                                <option value="10">October</option>
                                <option value="11">November</option>
                                <option value="12">December</option>
                            </select>

                            <select class="form-control" name="dob_year" required style="max-width: 80px;">
                                <option value="">Year</option>
                                <!-- Generate year options from current year to 1900 -->
                                <script>
                                    const currentYear = new Date().getFullYear();
                                    for (let year = currentYear; year >= 1900; year--) {
                                        document.write(`<option value="${year}">${year}</option>`);
                                    }
                                </script>
                            </select>
                        </div>
                    </td>
                </tr>

                <tr>
                    <th>Sex</th>
                    <td>
                        <select class="form-select" name="sex" required>
                            <option value="" disabled selected>Select Sex</option>
                            <option value="Male">Male</option>
                            <option value="Female">Female</option>
                            <option value="Other">Other</option>
                        </select>
                    </td>
                </tr>
                <tr>
                    <th>Marital Status</th>
                    <td>
                        <select class="form-select" name="maritalStatus" required>
                            <option value="" disabled selected>Select Marital Status</option>
                            <option value="Single">Single</option>
                            <option value="Married">Married</option>
                            <option value="Divorced">Divorced</option>
                            <option value="Widowed">Widowed</option>
                        </select>
                    </td>
                </tr>
                <tr>
                    <th>Hostel Address</th>
                    <td><input type="text" class="form-control" name="hostelAddress" placeholder="Hostel Address (optional)"></td>
                </tr>
                <tr>
                    <th>Home Town</th>
                    <td><input type="text" class="form-control" name="homeTown" placeholder="Home Town" required></td>
                </tr>
                <tr>
                    <th>Local Government Area (LGA)</th>
                    <td><input type="text" class="form-control" name="lga" placeholder="LGA" required></td>
                </tr>
                <tr>
                    <th>State</th>
                    <td><input type="text" class="form-control" name="state" placeholder="State" required></td>
                </tr>
                <tr>
                    <th>Country</th>
                    <td><input type="text" class="form-control" name="country" placeholder="Country" required></td>
                </tr>
                </tbody>
            </table>
        </div>
        <div class="d-flex justify-content-end mt-3 mb-3">
            <a href="/emr/dashboard/" class="btn btn-secondary me-3">Go Back</a>
            <button type="submit" id="submitButton" class="btn btn-success" style="width:20%;">Submit</button>
        </div>
        <div id="messageBox"></div>
    </form>
</div>

<div th:insert="fragments :: footer"></div>
<script>
    document.getElementById("addPatientForm").addEventListener("submit", async function (event) {
    event.preventDefault(); // Prevent default form submission

    const formData = new FormData(this);
    const submitButton = document.getElementById("submitButton"); // Get the submit button
    const messageBox = document.getElementById("messageBox");

    // Disable button and show loading spinner
    submitButton.disabled = true;
    submitButton.innerHTML = `<span class="spinner-border spinner-border-sm"></span> Processing...`;

    try {
        const response = await fetch("/emr/add-patient", {
            method: "POST",
            body: new URLSearchParams(formData) // Ensure form data is sent correctly
        });

        const result = await response.json(); // Parse JSON response
        messageBox.innerHTML = ""; // Clear previous messages

        if (result.success) {
            messageBox.innerHTML = `<div class="alert alert-success">${result.message}</div>`;
            this.reset(); // Reset form on success
        } else {
            let errorList = `<div class="alert alert-danger"><ul>`;
            result.errors.forEach(error => {
                errorList += `<li>${error}</li>`;
            });
            errorList += `</ul></div>`;
            messageBox.innerHTML = errorList;
        }
    } catch (error) {
        console.error("Error:", error);
        messageBox.innerHTML = `<div class="alert alert-danger">Something went wrong. Please try again.</div>`;
    } finally {
        // Restore button state
        submitButton.disabled = false;
        submitButton.innerHTML = `Add Patient`;
    }
});

</script>
</body>
</html>