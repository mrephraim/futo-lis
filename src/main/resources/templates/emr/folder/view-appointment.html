<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head th:insert="fragments :: folderHead(title = 'View Appointment')">
</head>
<body>

<div th:insert="fragments :: sidebar"></div>
<div class="content">
    <div class="container py-4">
        <h2>Appointment Details</h2>

        <!-- Vitals Section -->
        <div class="card">
            <div class="card-body">
                <h5>Vitals</h5>
                <p><strong>Blood Pressure:</strong> <span id="bloodPressure"></span></p>
                <p><strong>Pulse Rate:</strong> <span id="pulseRate"></span></p>
                <p><strong>Temperature:</strong> <span id="temperature"></span></p>
                <p><strong>Respiratory Rate:</strong> <span id="respiratoryRate"></span></p>
                <p><strong>Oxygen Saturation:</strong> <span id="oxygenSaturation"></span></p>
                <p><strong>Special Notes:</strong> <span id="specialNotes"></span></p>
            </div>
        </div>

        <div id="labOrdersSection" class="mt-3">
            <h5><span>Lab Test Orders</span> <button class="btn btn-outline-dark" onclick="openLabOrderForm()"><i class="bi bi-plus-circle"></i></button></h5>
            <table class="table">
                <thead>
                <tr>
                    <th>Test</th>
                    <th>Priority</th>
                    <th>Comment</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
                </thead>
                <tbody id="labOrdersBody"></tbody>
            </table>
        </div>

        <!-- Doctor's Notes -->
        <div class="mt-3">
            <h5>Doctor's Notes</h5>
            <textarea id="doctorNotes" class="form-control" rows="5" placeholder="Enter notes here..."></textarea>
        </div>

        <div class="row mt-3">
            <div class="col-2">
            <button class="btn btn-secondary" style="width:90%;">Save Progress</button>
            </div>
            <div class="col-3">
            <button class="btn btn-success" style="width:90%;">Finish Appointment</button>
            </div>
        </div>
    </div>
</div>

<!-- Lab Order Modal -->
<div id="labOrderModal" class="modal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">New Lab Test Order</h5>
                <button type="button" class="close btn-close" onclick="closeLabOrderForm()" ></button>
            </div>
            <div class="modal-body">
                <form id="labOrderForm">
                    <div class="mb-3">
                        <label for="testCategory" class="form-label">Test Category:</label>
                        <select id="testCategory" class="form-select" onchange="fetchTests()" required></select>
                    </div>

                    <div class="mb-3">
                        <label for="testType" class="form-label">Test Type:</label>
                        <select id="testType" class="form-select" required></select>
                    </div>

                    <div class="mb-3">
                        <label for="priority" class="form-label">Priority:</label>
                        <select id="priority" class="form-select" required>
                            <option value="normal">Normal</option>
                            <option value="urgent">Urgent</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label for="testComment" class="form-label">Comments:</label>
                        <textarea id="testComment" class="form-control" rows="3"></textarea>
                    </div>

                    <div class="modal-footer">
                        <button type="submit" class="btn btn-primary">Submit</button>
                        <button type="button" class="btn btn-secondary" onclick="closeLabOrderForm()">Close</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>


<div th:insert="fragments :: folderFooter"></div>

<script>
    const appointmentId = new URLSearchParams(window.location.search).get('id');

    function fetchVitals() {
        fetch(`/emr/api/vitals/${appointmentId}`)
            .then(response => response.json())
            .then(data => {
                document.getElementById("bloodPressure").textContent = data.bloodPressure;
                document.getElementById("pulseRate").textContent = data.pulseRate;
                document.getElementById("temperature").textContent = data.temperature;
                document.getElementById("respiratoryRate").textContent = data.respiratoryRate;
                document.getElementById("oxygenSaturation").textContent = data.oxygenSaturation;
                document.getElementById("specialNotes").textContent = data.specialNotes;
            });
    }

    function fetchCategories() {
        fetch(`/emr/api/lab-categories`)
            .then(response => response.json())
            .then(data => {
                const categorySelect = document.getElementById("testCategory");
                categorySelect.innerHTML = "<option value=''>Select Category</option>";
                data.forEach(category => {
                    categorySelect.innerHTML += `<option value="${category.id}">${category.name}</option>`;
                });
            });
    }

    function fetchTests() {
        const categoryId = document.getElementById("testCategory").value;
        fetch(`/emr/api/lab-tests/${categoryId}`)
            .then(response => response.json())
            .then(data => {
                const testSelect = document.getElementById("testType");
                testSelect.innerHTML = "<option value=''>Select Test</option>";
                data.forEach(test => {
                    testSelect.innerHTML += `<option value="${test.id}">${test.name}</option>`;
                });
            });
    }

    fetchVitals();
    fetchCategories();

    function openLabOrderForm() {
        // Example: Open a modal popup for lab order
        let modal = document.getElementById("labOrderModal");
        if (modal) {
            modal.style.display = "block";
        } else {
            console.error("Lab Order Modal not found");
        }
    }

    function closeLabOrderForm() {
    const modal = document.getElementById("labOrderModal");
    modal.style.display = "none";
}

</script>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        fetchLabOrders(); // Load lab orders when the page loads
    });

    function fetchLabOrders() {
        const appointmentId = new URLSearchParams(window.location.search).get("id"); // Get appointment ID from URL
        if (!appointmentId) return;

        fetch(`/emr/api/lab-orders/${appointmentId}`)
            .then(response => response.json())
            .then(labOrders => {
                const labOrdersBody = document.getElementById("labOrdersBody");
                labOrdersBody.innerHTML = ""; // Clear previous data

                if (labOrders.length > 0) {
                    document.getElementById("labOrdersSection").style.display = "block"; // Show section

                    labOrders.forEach(order => {
                        const viewResultButton = order.requisitionId
                            ? `<a href="/lis/result-printout/${order.requisitionId}" class="btn btn-success btn-sm">View Result</a>`
                            : ""; // Only show if requisitionId exists

                        const row = document.createElement("tr");
                        row.innerHTML = `
                            <td>${order.testType}</td>
                            <td>${order.priority}</td>
                            <td>${order.comment ? order.comment : "N/A"}</td>
                            <td>${order.status}</td>
                            <td>${viewResultButton}</td> <!-- Show button only if requisitionId exists -->
                        `;
                        labOrdersBody.appendChild(row);
                    });
                } else {
                    document.getElementById("labOrdersSection").style.display = "none"; // Hide section if no orders
                }
            })
            .catch(error => console.error("Error fetching lab orders:", error));
    }
</script>



<script>
    document.addEventListener("DOMContentLoaded", function () {
        document.getElementById("labOrderForm").addEventListener("submit", function (event) {
            event.preventDefault(); // Prevent default form submission

            const appointmentId = new URLSearchParams(window.location.search).get("id"); // Get appointment ID from URL
            const testCategory = document.getElementById("testCategory").value;
            const testType = document.getElementById("testType").value;
            const priority = document.getElementById("priority").value;
            const comment = document.getElementById("testComment").value;

            if (!testCategory || !testType || !priority) {
                alert("Please fill all required fields!");
                return;
            }

            const labOrderData = {
                appointmentId: parseInt(appointmentId),
                testCategory: parseInt(testCategory),
                testType: parseInt(testType),
                priority: priority,
                comment: comment.trim()
            };

            fetch("/emr/api/lab-orders", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(labOrderData)
            })
            .then(response => response.json())
            .then(data => {
                alert(data.message); // Show success message
                document.getElementById("labOrderForm").reset(); // Clear form
                window.reload();
            })
            .catch(error => console.error("Error placing lab order:", error));
        });
    });
</script>

</body>
</html>
