
<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<!-- Head Fragment-->
<head th:fragment="head (title)">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${title}">HOME - FUTO HIS</title>
    <link rel="stylesheet" href="/static/css/bootstrap.css">
    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css"
          integrity="sha384-4LISF5TTJX/fLmGSxO53rV4miRxdg84mZsxmO8Rx5jGtp/LbrixFETvWa5a6sESd"
          crossorigin="anonymous">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0&icon_names=experiment" />
    <link rel="stylesheet" href="/static/main.css">
</head>
<head th:insert="fragments :: head(title = 'DASHBOARD - LIS Admin Portal - FUTO HIS')"></head>
<style>

</style>
<body>
<div class="container">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="mb-5" th:insert="fragments :: headerOne(title='PENDING REQUISITIONS')"></div>
            <!-- Table for Pending Lab Requisitions -->
            <div class="card shadow-sm">
                <h2 class="card-title card-header">Pending Requisitions  <a class="btn btn-dark ms-5" href="/lis/requisitions">View all requisitions </a></h2>

                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                <thead>
                <tr>
                    <th>Requisition ID</th>
                    <th>Patient Name</th>
                    <th>Test Name</th>
                    <th>Priority</th>
                    <th>Actions</th>
                </tr>
                </thead>
                <tbody id="pendingRequisitionsTableBody">
                <!-- Data will be dynamically loaded here -->
                </tbody>
            </table>
                </div>
            </div>

            <!-- Link to view archived requisitions -->
            <div class="mt-3 text-center">
                <a href="/lis/requisitions?type=archived" class="btn btn-link hover-pill">View Archived Requisitions</a>
            </div>
        </div>
    </div>

    <div th:insert="fragments :: footer"></div>
</div>

<script>
    // Function to fetch pending lab requisitions
    async function fetchPendingRequisitions() {
        try {
            const response = await fetch('/lis/api/requisitions/pending', {
                method: 'GET',
                headers: { 'Content-Type': 'application/json' }
            });

            if (response.ok) {
                const requisitions = await response.json();
                populateRequisitionsTable(requisitions);
            } else {
                console.error('Error fetching requisitions:', response.statusText);
                alert('Failed to load pending requisitions.');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('An error occurred while fetching requisitions.');
        }
    }

    // Function to populate the table with requisitions
    // Function to populate the table with requisitions
    function populateRequisitionsTable(requisitions) {
        const tableBody = document.getElementById('pendingRequisitionsTableBody');
        tableBody.innerHTML = ''; // Clear existing table rows

        requisitions.forEach(req => {
            const row = document.createElement('tr');
            row.classList.add('hover-card');
            row.onclick = () => {
                window.location.href = `/lis/view-requisition?id=${req.id}`;
            };

            row.innerHTML = `
                <td>${req.id}</td>
                <td>${req.patientName}</td>
                <td>${req.labTest}</td>
                <td>${req.priority}</td>
                <td>
                    <a href="/lis/process-result?id=${req.id}" class="btn btn-outline-success btn-sm me-2 hover-pill" >Process</a>
                    <button class="btn btn-outline-danger btn-sm hover-pill" onclick="event.stopPropagation(); archiveRequisition(${req.id})">Archive</button>
                </td>
            `;
            tableBody.appendChild(row);
        });
    }

    // Function to process requisition
    async function processRequisition(id) {
        try {
            const response = await fetch(`/lis/api/requisitions/process/${id}`, { method: 'POST' });

            if (response.ok) {
                alert('Requisition processed successfully!');
                fetchPendingRequisitions(); // Refresh the table
            } else {
                alert('Failed to process requisition.');
            }
        } catch (error) {
            console.error('Error processing requisition:', error);
            alert('An error occurred while processing the requisition.');
        }
    }

    // Function to archive requisition
    async function archiveRequisition(id) {
        try {
            const response = await fetch(`/lis/api/requisitions/archive/${id}`, { method: 'POST' });

            if (response.ok) {
                alert('Requisition archived successfully!');
                fetchPendingRequisitions(); // Refresh the table
            } else {
                alert('Failed to archive requisition.');
            }
        } catch (error) {
            console.error('Error archiving requisition:', error);
            alert('An error occurred while archiving the requisition.');
        }
    }

    // Fetch requisitions on page load
    document.addEventListener('DOMContentLoaded', fetchPendingRequisitions);
</script>

</body>
</html>
